<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED Strip Visualizer</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #121212;
            color: #f5f5f5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #bb86fc;
        }
        
        .control-panel {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #bb86fc;
        }
        
        select, input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #333;
            background-color: #2d2d2d;
            color: #fff;
        }
        
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-start {
            background-color: #03dac6;
            color: #000;
        }
        
        .btn-stop {
            background-color: #cf6679;
            color: #fff;
        }
        
        .btn-start:hover {
            background-color: #00c4b4;
        }
        
        .btn-stop:hover {
            background-color: #b55a69;
        }
        
        .visualizer {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .led-strip {
            display: flex;
            height: 50px;
            border-radius: 25px;
            overflow: hidden;
            margin-bottom: 20px;
            background-color: #121212;
        }
        
        .led {
            flex: 1;
            height: 100%;
            transition: background-color 0.1s ease;
        }
        
        .status {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 10px;
            background-color: #2d2d2d;
            border-radius: 4px;
        }
        
        .status-metrics {
            display: flex;
            gap: 15px;
        }
        
        .metric {
            padding: 3px 8px;
            border-radius: 4px;
            background-color: #333;
            font-size: 14px;
        }
        
        .metric-highlight {
            background-color: #bb86fc;
            color: #000;
            font-weight: bold;
        }
        
        .pulsing {
            animation: pulse 0.5s ease-in-out;
        }
        
        .alerts-container {
            margin-bottom: 20px;
        }
        
        .alert {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alert-error {
            background-color: #cf6679;
            color: #fff;
        }
        
        .alert-success {
            background-color: #03dac6;
            color: #000;
        }
        
        .alert-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: inherit;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LED Strip Visualizer</h1>
        
        <div class="alerts-container" id="alerts">
            <!-- Alerts will be inserted here -->
        </div>

        <div class="control-panel">
            <div class="form-group">
                <label for="audio-device">Audio Device</label>
                <select id="audio-device">
                    <option value="">Loading devices...</option>
                </select>
                
                <div style="margin-top: 10px;">
                    <input type="checkbox" id="use-mock-audio" style="width: auto; margin-right: 10px;">
                    <label for="use-mock-audio" style="display: inline;">Use synthetic audio (no real audio input)</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="visualization-type">Visualization Type</label>
                <select id="visualization-type" class="form-select">
                    <option value="spectrum">Spectrum</option>
                    <option value="beat_pulse">Beat Pulse</option>
                    <option value="energy_beat">Energy Beat</option>
                    <option value="bass_impact">Bass Impact</option>
                    <option value="frequency_bars">Frequency Bars</option>
                    <option value="vu_meter">VU Meter</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="arduino-port">Arduino Port</label>
                <input type="text" id="arduino-port" value="/dev/tty.usbserial-110">

                <div style="margin-top: 10px;">
                    <input type="checkbox" id="mock-arduino" style="width: auto; margin-right: 10px;">
                    <label for="mock-arduino" style="display: inline;">Mock Arduino (use if no hardware connected)</label>
                </div>
            </div>
            
            <div class="button-group">
                <button id="btn-start" class="btn-start">Start Visualization</button>
                <button id="btn-stop" class="btn-stop" disabled>Stop Visualization</button>
            </div>
        </div>
        
        <div class="visualizer">
            <div class="led-strip" id="led-strip">
                <!-- LEDs will be generated by JavaScript -->
            </div>
            
            <div class="status">
                <span id="status-text">Ready</span>
                <div class="status-metrics">
                    <span id="fps" class="metric">0 FPS</span>
                    <span id="target-fps" class="metric">Target: 0</span>
                    <span id="arduino-fps" class="metric metric-highlight">Arduino: 0</span>
                    <span id="sent-fps" class="metric">Sent: 0</span>
                    <span id="buffer" class="metric">Buffer: 0%</span>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        // Elements
        const audioDeviceSelect = document.getElementById('audio-device');
        const visualizationTypeSelect = document.getElementById('visualization-type');
        const arduinoPortInput = document.getElementById('arduino-port');
        const startButton = document.getElementById('btn-start');
        const stopButton = document.getElementById('btn-stop');
        const ledStrip = document.getElementById('led-strip');
        const statusText = document.getElementById('status-text');
        const fpsText = document.getElementById('fps');
        const alertsContainer = document.getElementById('alerts');
        
        // Variables
        let socket;
        let isRunning = false;
        const numLeds = 60;
        
        // Create LED elements
        function initializeLEDs() {
            ledStrip.innerHTML = '';
            for (let i = 0; i < numLeds; i++) {
                const led = document.createElement('div');
                led.className = 'led';
                led.style.backgroundColor = '#121212';
                ledStrip.appendChild(led);
            }
        }
        
        // Connect to Socket.IO server
        function connectSocket() {
            socket = io();
            
            socket.on('connect', () => {
                showAlert('Connected to server', 'success');
                loadDevices();
                setStatus('Connected');
            });
            
            socket.on('connect_error', (error) => {
                showAlert('Connection error: ' + error.message, 'error');
                setStatus('Connection error');
            });
            
            socket.on('error', (data) => {
                showAlert(data.message, 'error');
                if (isRunning) {
                    isRunning = false;
                    updateButtonState();
                    setStatus('Error');
                }
            });
            
            socket.on('visualization_started', (data) => {
                showAlert(`Visualization started: ${data.visualization_type} using ${data.device}`, 'success');
                isRunning = true;
                updateButtonState();
                setStatus('Running');
            });
            
            socket.on('visualization_stopped', () => {
                showAlert('Visualization stopped', 'success');
                isRunning = false;
                updateButtonState();
                setStatus('Stopped');
                fpsText.textContent = '0 FPS';
                document.getElementById('target-fps').textContent = 'Target: 0';
                document.getElementById('arduino-fps').textContent = 'Arduino: 0';
                document.getElementById('sent-fps').textContent = 'Sent: 0';
                document.getElementById('buffer').textContent = 'Buffer: 0%';
                clearLEDs();
            });
            
            socket.on('visualization_data', (data) => {
                updateLEDs(data.led_colors);
                if (data.beat) {
                    ledStrip.classList.add('pulsing');
                    setTimeout(() => {
                        ledStrip.classList.remove('pulsing');
                    }, 100);
                }
                
                // Update metrics
                fpsText.textContent = `${data.fps} FPS`;
                document.getElementById('target-fps').textContent = `Target: ${data.target_fps}`;
                document.getElementById('sent-fps').textContent = `Sent: ${data.sent_fps}`;
                
                // Highlight Arduino FPS when it changes from 0
                const arduinoFpsElement = document.getElementById('arduino-fps');
                if (data.arduino_fps > 0 && arduinoFpsElement.textContent === 'Arduino: 0') {
                    arduinoFpsElement.classList.add('metric-highlight');
                    setTimeout(() => arduinoFpsElement.classList.remove('metric-highlight'), 3000);
                }
                arduinoFpsElement.textContent = `Arduino: ${data.arduino_fps}`;
                
                document.getElementById('buffer').textContent = `Buffer: ${data.buffer}%`;
            });
            
            socket.on('disconnect', () => {
                showAlert('Disconnected from server', 'error');
                setStatus('Disconnected');
                isRunning = false;
                updateButtonState();
            });
        }
        
        // Load audio devices from server
        function loadDevices() {
            fetch('/api/devices')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        audioDeviceSelect.innerHTML = '';
                        
                        if (data.devices.length === 0) {
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = 'No devices found';
                            audioDeviceSelect.appendChild(option);
                        } else {
                            data.devices.forEach(device => {
                                const option = document.createElement('option');
                                option.value = device.id;
                                // Show channel info
                                let deviceText = device.name;
                                if (device.inputs > 0) {
                                    deviceText += ` (${device.inputs} in)`;
                                }
                                if (device.outputs > 0) {
                                    deviceText += ` (${device.outputs} out)`;
                                }
                                option.textContent = deviceText;
                                audioDeviceSelect.appendChild(option);
                                
                                // Pre-select BlackHole if available
                                if (device.name.includes('BlackHole')) {
                                    option.selected = true;
                                }
                            });
                        }
                    } else {
                        showAlert('Failed to load audio devices: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    showAlert('Error loading audio devices: ' + error.message, 'error');
                });
        }
        
        // Start visualization
        function startVisualization() {
            const deviceId = audioDeviceSelect.value;
            const deviceName = audioDeviceSelect.options[audioDeviceSelect.selectedIndex]?.textContent || '';
            const visualizationType = visualizationTypeSelect.value;
            const arduinoPort = arduinoPortInput.value;
            const mockArduino = document.getElementById('mock-arduino').checked;
            const useMockAudio = document.getElementById('use-mock-audio').checked;
            
            if (!deviceId && !useMockAudio) {
                showAlert('Please select an audio device or use synthetic audio', 'error');
                return;
            }
            
            setStatus('Starting...');
            
            socket.emit('start_visualization', {
                device_id: deviceId,
                device_name: deviceName.split(' (')[0], // Remove the channel info
                visualization_type: visualizationType,
                arduino_port: arduinoPort,
                mock_arduino: mockArduino,
                use_mock_audio: useMockAudio
            });
        }
        
        // Stop visualization
        function stopVisualization() {
            if (!isRunning) return;
            
            setStatus('Stopping...');
            socket.emit('stop_visualization', {});
        }
        
        // Update LED display
        function updateLEDs(colors) {
            const leds = ledStrip.children;
            
            // Check if colors is an array of tuples or a flat array
            const isTupleFormat = Array.isArray(colors) && 
                                  colors.length > 0 && 
                                  Array.isArray(colors[0]);
            
            for (let i = 0; i < leds.length; i++) {
                let r, g, b;
                
                if (isTupleFormat) {
                    // Handle tuple format [(r,g,b), (r,g,b), ...]
                    if (i < colors.length) {
                        [r, g, b] = colors[i];
                    } else {
                        [r, g, b] = [0, 0, 0];
                    }
                } else {
                    // Handle flat format [r,g,b,r,g,b,...]
                    const colorIndex = i * 3;
                    if (colorIndex + 2 < colors.length) {
                        r = colors[colorIndex];
                        g = colors[colorIndex + 1];
                        b = colors[colorIndex + 2];
                    } else {
                        [r, g, b] = [0, 0, 0];
                    }
                }
                
                leds[i].style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
            }
        }
        
        // Clear all LEDs
        function clearLEDs() {
            const leds = ledStrip.children;
            for (let i = 0; i < leds.length; i++) {
                leds[i].style.backgroundColor = '#121212';
            }
        }
        
        // Update UI based on running state
        function updateButtonState() {
            startButton.disabled = isRunning;
            stopButton.disabled = !isRunning;
            audioDeviceSelect.disabled = isRunning;
            visualizationTypeSelect.disabled = isRunning;
            arduinoPortInput.disabled = isRunning;
        }
        
        // Show alert message
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span>${message}</span>
                <button class="alert-close">&times;</button>
            `;
            
            alert.querySelector('.alert-close').addEventListener('click', () => {
                alert.remove();
            });
            
            alertsContainer.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode === alertsContainer) {
                    alert.remove();
                }
            }, 5000);
        }
        
        // Set status text
        function setStatus(status) {
            statusText.textContent = status;
        }
        
        // Event listeners
        startButton.addEventListener('click', startVisualization);
        stopButton.addEventListener('click', stopVisualization);
        
        // Initialize
        initializeLEDs();
        connectSocket();
        updateButtonState();
    </script>
</body>
</html> 